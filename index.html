<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Universal AI Chat Interface</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
  </style>
</head>

<body class="h-screen bg-gray-900 text-gray-100 flex overflow-hidden">

<!-- ================= SIDEBAR ================= -->
<aside class="w-64 bg-gray-800 border-r border-gray-700 flex flex-col">
  <div class="p-4 flex justify-between items-center border-b border-gray-700">
    <h1 class="font-bold">AI Chats</h1>
    <button onclick="newChat()" class="bg-blue-600 px-2 rounded">+</button>
  </div>

  <div id="chatList" class="flex-1 overflow-y-auto p-2 space-y-1"></div>

  <div class="p-3 border-t border-gray-700">
    <button onclick="openSettings()" class="w-full bg-gray-700 hover:bg-gray-600 py-2 rounded">
      ⚙ Settings
    </button>
  </div>
</aside>

<!-- ================= MAIN ================= -->
<main class="flex-1 flex flex-col">
  <div id="chatHeader" class="p-4 border-b border-gray-700 text-gray-400 text-sm">
    New Chat
  </div>

  <div id="chatArea" class="flex-1 overflow-y-auto p-4 space-y-3"></div>

  <div class="p-4 border-t border-gray-700 flex gap-2">
    <textarea id="userInput"
      class="flex-1 bg-gray-800 border border-gray-700 rounded p-2 resize-none focus:outline-none"
      rows="2"
      placeholder="Type a message..."
    ></textarea>
    <button onclick="sendMessage()" class="bg-blue-600 px-4 rounded">
      Send
    </button>
  </div>
</main>

<!-- ================= SETTINGS MODAL ================= -->
<div id="settingsModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center">
  <div class="bg-gray-800 w-full max-w-md rounded p-6 space-y-4">
    <h2 class="text-lg font-semibold">Settings</h2>

    <div>
      <label class="text-sm text-gray-400">Blackbox API Key</label>
      <input id="apiKeyInput" type="password"
        class="w-full bg-gray-900 border border-gray-700 rounded p-2 mt-1"
        placeholder="Paste API Key" />
    </div>

    <div>
      <label class="text-sm text-gray-400">Model Name</label>
      <input id="modelInput" type="text"
        class="w-full bg-gray-900 border border-gray-700 rounded p-2 mt-1"
        placeholder="blackboxai / gpt-4 / claude-3-opus" />
    </div>

    <div id="apiStatus" class="text-sm"></div>

    <div class="flex justify-end gap-2 pt-2">
      <button onclick="closeSettings()" class="bg-gray-600 px-4 py-2 rounded">
        Cancel
      </button>
      <button onclick="verifyAndSave()" class="bg-blue-600 px-4 py-2 rounded">
        Verify & Save
      </button>
    </div>
  </div>
</div>

<!-- ================= SCRIPT (END OF BODY) ================= -->
<script>
/* ================= STATE ================= */
let chats = JSON.parse(localStorage.getItem("chats") || "{}");
let currentChatId = localStorage.getItem("currentChat") || null;

let apiKey = localStorage.getItem("bb_api_key") || "";
let modelName = localStorage.getItem("bb_model") || "";
let apiVerified = localStorage.getItem("bb_verified") === "true";

/* ================= INIT ================= */
document.getElementById("apiKeyInput").value = apiKey;
document.getElementById("modelInput").value = modelName;

renderChats();
if (currentChatId) loadChat(currentChatId);

/* ================= CHAT LOGIC ================= */
function newChat() {
  const id = "chat_" + Date.now();
  chats[id] = { title: "New Chat", messages: [] };
  currentChatId = id;
  saveState();
  renderChats();
  loadChat(id);
}

function renderChats() {
  const list = document.getElementById("chatList");
  list.innerHTML = "";
  Object.keys(chats).reverse().forEach(id => {
    const btn = document.createElement("button");
    btn.className = "w-full text-left px-3 py-2 rounded hover:bg-gray-700";
    btn.textContent = chats[id].title;
    btn.onclick = () => loadChat(id);
    list.appendChild(btn);
  });
}

function loadChat(id) {
  currentChatId = id;
  document.getElementById("chatHeader").textContent = chats[id].title;
  const area = document.getElementById("chatArea");
  area.innerHTML = "";
  chats[id].messages.forEach(m => addMessage(m.role, m.content));
  saveState();
}

function addMessage(role, text) {
  const div = document.createElement("div");
  div.className = role === "user" ? "text-right" : "text-left text-blue-400";
  div.innerHTML = `
    <div class="inline-block bg-gray-800 px-3 py-2 rounded max-w-xl">
      ${text}
    </div>`;
  chatArea.appendChild(div);
  chatArea.scrollTop = chatArea.scrollHeight;
}

async function sendMessage() {
  if (!apiVerified) {
    alert("Please verify your API key in Settings first.");
    return;
  }

  const input = userInput.value.trim();
  if (!input) return;
  userInput.value = "";

  addMessage("user", input);
  chats[currentChatId].messages.push({ role: "user", content: input });

  addMessage("assistant", "Thinking...");

  try {
    const res = await fetch("https://api.blackbox.ai/api/chat", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + apiKey
      },
      body: JSON.stringify({
        model: modelName,
        messages: chats[currentChatId].messages
      })
    });

    const data = await res.json();
    chatArea.lastChild.remove();

    const reply = data.response || "No response";
    addMessage("assistant", reply);
    chats[currentChatId].messages.push({ role: "assistant", content: reply });
    saveState();

  } catch {
    chatArea.lastChild.remove();
    addMessage("assistant", "❌ API Error");
  }
}

/* ================= SETTINGS ================= */
function openSettings() {
  settingsModal.classList.remove("hidden");
  settingsModal.classList.add("flex");
}

function closeSettings() {
  settingsModal.classList.add("hidden");
}

async function verifyAndSave() {
  const key = apiKeyInput.value.trim();
  const model = modelInput.value.trim();
  apiStatus.textContent = "Verifying API key...";

  if (!key || !model) {
    apiStatus.textContent = "API key and model required.";
    return;
  }

  try {
    const res = await fetch("https://api.blackbox.ai/api/chat", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + key
      },
      body: JSON.stringify({
        model: model,
        messages: [{ role: "user", content: "ping" }],
        max_tokens: 5
      })
    });

    if (!res.ok) throw new Error();
    const data = await res.json();
    if (!data.response) throw new Error();

    apiKey = key;
    modelName = model;
    apiVerified = true;

    localStorage.setItem("bb_api_key", key);
    localStorage.setItem("bb_model", model);
    localStorage.setItem("bb_verified", "true");

    apiStatus.textContent = "✅ API Verified";
    setTimeout(closeSettings, 700);

  } catch {
    apiStatus.textContent = "❌ Invalid API key or model";
    localStorage.setItem("bb_verified", "false");
  }
}

/* ================= STORAGE ================= */
function saveState() {
  localStorage.setItem("chats", JSON.stringify(chats));
  localStorage.setItem("currentChat", currentChatId);
}
</script>

</body>
</html>
